
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Dispatch Source - Summerrose’s Blog</title>
  <meta name="author" content="ghren">

  
  <meta name="description" content="目录 概述
事件与种类
使用 Dispatch Source 概述 iOS 中有两种 Source，一种是 Run Loop Source ,一种是 Dispatch Source。 Source 可以理解为产生事件的地方，Source 产生事件，然后 Source 的回调函数负责 处理这些事件 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://alex1212112.github.io/blog/2015/11/24/dispatch-source">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Summerrose’s Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>


  

</head>

<body   >
  <header role="banner"><hgroup>
</hgroup>

</header>
  <!-- <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:alex1212112.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav> -->
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Dispatch Source</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-24T00:16:49+08:00" pubdate data-updated="true">Nov 24<span>th</span>, 2015</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><h3>目录</h3>

<ol>
<li>概述</li>
<li>事件与种类</li>
<li>使用 Dispatch Source</li>
</ol>


<h3>概述</h3>

<p>iOS 中有两种 Source，一种是 Run Loop Source ,一种是 Dispatch Source。</p>

<p>Source 可以理解为产生事件的地方，Source 产生事件，然后 Source 的回调函数负责 处理这些事件。</p>

<p>在 Run Loop 中， Run Loop Source 产生事件，之后唤醒 Run Loop， Run Loop 便执行该 Source 的回调函数。</p>

<p>Dispatch Source 也会产生一些特定的事件，当这些事件发生的时候，其回调的 block 会自动加入到 对应的 dispatch queue 中。</p>

<h3>事件与种类</h3>

<p>Dispatch Source 监控的事件主要有以下几种：</p>

<ol>
<li>Timer dispatch sources generate periodic notifications.</li>
<li>Signal dispatch sources notify you when a UNIX signal arrives.</li>
<li>Descriptor sources notify you of various file- and socket-based operations, such as:

<ul>
<li>When data is available for reading</li>
<li>When it is possible to write data</li>
<li>When files are deleted, moved, or renamed in the file system</li>
<li>When file meta information changes</li>
</ul>
</li>
<li>Process dispatch sources notify you of process-related events, such as:

<ul>
<li>When a process exits</li>
<li>When a process issues a fork or exec type of call</li>
<li>When a signal is delivered to the process</li>
</ul>
</li>
<li>Mach port dispatch sources notify you of Mach-related events.</li>
<li>Custom dispatch sources are ones you define and trigger yourself.</li>
</ol>


<p>对应着系统定义的 Dispatch Source 种类：</p>

<ol>
<li>DISPATCH_SOURCE_TYPE_TIMER 定时器</li>
<li>DISPATCH_SOURCE_TYPE_SIGNAL 接收到 UNIX 信号</li>
<li>DISPATCH_SOURCE_TYPE_READ 文件可读</li>
<li>DISPATCH_SOURCE_TYPE_WRITE 文件可写</li>
<li>DISPATCH_SOURCE_TYPE_VNODE 文件系统有变更</li>
<li>DISPATCH_SOURCE_TYPE_PROC 与进程相关的事件</li>
<li>DISPATCH_SOURCE_TYPE_MACH_SEND  Mach 端口发送事件</li>
<li>DISPATCH_SOURCE_TYPE_MACH_RECV  Mach 端口接收事件</li>
<li>DISPATCH_SOURCE_TYPE_DATA_ADD 用户自定义的事件－变量相加</li>
<li>DISPATCH_SOURCE_TYPE_DATA_OR  用户自定义的事件－变量相或</li>
</ol>


<p>这些事件都是来自于 XNU 内核中，kqueue 是用来处理这些事件的最好的一种方法，Dispatch Source 就是对 kqueue 的封装。</p>

<h3>使用 Dispatch Source</h3>

<p>使用 Dispatch Source 一般分为以下几步：</p>

<ol>
<li>创建 Dispatch Source</li>
<li>配置 Dispatch Source</li>
<li>启动 Dispathc source</li>
<li>手动或自动发送 Dispatch Source 事件</li>
</ol>


<h4>自定义 Dispatch Source</h4>

<p>首先创建并配置 Dispatch Sourcce</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>self.count = 0;
</span><span class='line'>dispatch_queue_t queue = dispatch_get_main_queue();
</span><span class='line'>self.source = dispatch_source_create(DISPATCH_SOURCE_TYPE_DATA_ADD, 0, 0, queue);//创建 Dispatch Source，种类为DISPATCH_SOURCE_TYPE_DATA_ADD，即获取到的变量会相加
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>dispatch_source_set_event_handler(self.source, ^{
</span><span class='line'>
</span><span class='line'>    UInt64 value = dispatch_source_get_data(self.source);
</span><span class='line'>    
</span><span class='line'>    self.count += value;
</span><span class='line'>    NSLog(@"n = %ld",(long)self.count);
</span><span class='line'>    
</span><span class='line'>});//配置 Dispatch Source 的回调 block，即当收到该 Source 事件时候，就把该 block 追加到对应的queue中
</span><span class='line'>
</span><span class='line'>dispatch_resume(self.source); //启动 Source， Source 默认是 suspend 的，需要手动启动</span></code></pre></td></tr></table></div></figure>


<p>发送 Dispatch Source 事件</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>- (IBAction)buttonDidClicked:(id)sender {
</span><span class='line'>    
</span><span class='line'>    self.count = 0.0;
</span><span class='line'>    
</span><span class='line'>    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT , 0);
</span><span class='line'>    
</span><span class='line'>    for (NSInteger i = 0; i &lt; 100; i++) {
</span><span class='line'>        
</span><span class='line'>        dispatch_async(queue, ^{
</span><span class='line'>            
</span><span class='line'>            dispatch_source_merge_data(self.source, 1);//发送 Source 事件
</span><span class='line'>            sleep(1);
</span><span class='line'>            
</span><span class='line'>        });
</span><span class='line'>    }
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>之后，我们点击按钮之后，就会通过全局并发队列 发送 100 次 Source 事件，不过并不会 回调 100 次 回调 Block， 这是因为对应的 队列在接收到 Source 事件之后，假如队列处于空闲状态，就会执行对应的 回调 Block，假如队列处于 busy 状态，该事件就会和后面的一系列同种事件通过一定的方式被合并起来（此例中是按照相加的方式），等到队列空闲的时候再执行。</p>

<h4>Dispatch Source Timer</h4>

<p>利用 Dispatch Source 的 DISPATCH_SOURCE_TYPE_TIMER 类型，我们可以创建一个 跨线程的 定时器（我们平时使用的 NSTimer 是基于 Run Loop 的 timer 事件，只能在对应的线程里触发）</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>dispatch_queue_t queue = dispatch_get_main_queue();
</span><span class='line'>self.timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);//创建一个 timer；
</span><span class='line'>dispatch_source_set_timer(self.timer, DISPATCH_TIME_NOW, 2 * NSEC_PER_SEC, 0 * NSEC_PER_SEC);//配置 timer，从现在起，每两秒在主线程触发一次，精度为0s
</span><span class='line'>dispatch_source_set_event_handler(self.timer, ^{
</span><span class='line'>    
</span><span class='line'>    NSLog(@"%ld", self.count++);
</span><span class='line'>});//timer 触发之后的回调 block
</span><span class='line'>
</span><span class='line'>dispatch_resume(self.time); //启动 timer</span></code></pre></td></tr></table></div></figure>


<h3>参考资料</h3>

<ol>
<li><p><a href="https://developer.apple.com/library/mac/documentation/General/Conceptual/ConcurrencyProgrammingGuide/GCDWorkQueues/GCDWorkQueues.html">Dispatch Sources</a>;</p></li>
<li><p><a href="http://www.dreamingwish.com/article/grand-central-dispatch-basic-3.html">GCD入门（三）: Dispatch Sources</a>;</p></li>
<li><p><a href="https://github.com/ChenYilong/ParseSourceCodeStudy/blob/master/01_Parse%E7%9A%84%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%A4%84%E7%90%86%E6%80%9D%E8%B7%AF/Parse%E7%9A%84%E5%BA%95%E5%B1%82%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%A4%84%E7%90%86%E6%80%9D%E8%B7%AF.md">Parse的底层多线程处理思路：GCD高级用法</a>;</p></li>
</ol>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">ghren</span></span>

      








  


<time datetime="2015-11-24T00:16:49+08:00" pubdate data-updated="true">Nov 24<span>th</span>, 2015</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://alex1212112.github.io/blog/2015/11/24/dispatch-source/" data-via="" data-counturl="http://alex1212112.github.io/blog/2015/11/24/dispatch-source/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/11/21/run-loop/" title="Previous Post: Run Loop">&laquo; Run Loop</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/11/24/dispatch-source/">Dispatch Source</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/21/run-loop/">Run Loop</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/10/23/ios-zhong-xian-cheng-tong-bu-de-%5B%3F%5D-xie-fang-fa/">iOS 中线程同步的一些方法</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/19/reactivecocoa-xue-xi-zi-liao/">ReactiveCocoa 学习资料</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/27/guan-yu-uilocalnotification-de-ji-ge-wen-ti/">关于 UILocalNotification 的几个问题</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - ghren -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'alex1212112';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://alex1212112.github.io/blog/2015/11/24/dispatch-source/';
        var disqus_url = 'http://alex1212112.github.io/blog/2015/11/24/dispatch-source/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
